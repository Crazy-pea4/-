# 2022.3.13

在此日期之前还未还未决定要写一个项目日志，随着项目由云开发到与后端进行配合，发现会出现许多意料不到的问题。因此该项目日志就显得尤为必要。

## 静态页面搭建

在之前已经完成了对小程序“我的”模块的静态页面搭建，对于页面中的元素与窗口之间的距离多用padding来控制（这是因为padding保留了点击区间），页面中元素之间的距离多用margin来控制。右箭头icon采用的是vantUI小程序框架中自带的，而有些需要自定义的icon图标去阿里iconfont商城查找，但是在运用过程中出现了问题，icon无法正常显示，经过查阅文档（https://blog.csdn.net/liusunquan123/article/details/88885241）得知，需要将下载下来的文件夹中的.ttf文件在网站https://transfonter.org/手动转换成base64。转换完成后解压文件夹，打开其中的.css文件，将其中的所有内容（或者src）复制粘贴到项目的app.wxss中，小图标即可正常显示。

# 2022.3.14

## 我的-编辑资料

~~最开始，在后端接口还未完善的时候，用的是微信小程序开发自带的云开发功能。~~

现已使用后端接口。实现的功能如下：

1. 可编辑“昵称”、“个性签名”、“性别”和“头像”，其中“性别”为选择器菜单
2. 用户修改“昵称”、“个性签名”、“性别”，若为点击保存按钮就退出，则会弹出提醒框
3. 用户可拍摄图片或从相册选择图片来修改“头像”，修改头像未保存不会触发提醒框
4. 用户进入“编辑资料”页面但不做任何修改，则不会弹出提醒框
5. 用户修改了“昵称”或“头像”并保存后返回“我的”页面，页面顶部对应的昵称和头像也会修改

### 设计思路：

环节:1：用户打开“我的”页面，判断用户是否登录，若是则进入环节二，若否则弹出提醒框并在延迟时间后跳转至登录页面

环节2：发起网络请求（在上线阶段，这里应该在登录完成后拿到数据），拿到用户数据并将部分数据存储到缓存中（包含nickname、signature、sexIndex、headAddr）。同时“我的”页面上nickname和头像部分也要实时更新。这些都在onLoad函数中实现。若此时用户进入“编辑资料”页面，则进入环节三

环节3：“编辑资料”页面拥有与“我的”页面相似的用户登录检测行为。若通过，将页面上的昵称、个性签名、性别从缓存中获取对应的值。在该页面上提供了两个输入框对应昵称、个性签名，性别由vantUI小程序框架提供的picker选择器，详见文档https://vant-contrib.gitee.io/vant-weapp/#/picker，以及一个image组件提供显示与改变头像的功能，还有一个保存按钮用于用户的确认修改以及发送数据请求。用户修改除头像以外的数据未保存就退出，会触发提醒框询问。若用户退出至“我的”页面，则进入到环节4

环节3.1：这部分是对“编辑资料”页面的数据请求逻辑的说明。

对于昵称。个性签名、性别，任意一次修改都会使页面~~进入“已修改状态”（isChange = ture）同时会~~触发wx.enableAlertBeforeUnload()，若用户未保存退出，则会弹出提醒框询问；若用户点击了保存按钮，则先向服务器发送数据，然后将新数据放入缓存中（更新数据），最后会触发wx.disableAlertBeforeUnload()取消提醒框询问功能。

对于头像，任意一次修改不会触发wx.enableAlertBeforeUnload()，每次修改头像后立即发送数据至服务器。这里使用wx.chooseMedia()将选中的文件生成一个临时路径，在其成功回调中使用wx.uploadFile()与后端服务器进行交流，随后再在其成功回调中对data中的headAddr赋值，并将新数据放入缓存中（更新数据）。

环节4：用户重新回到“我的”页面时，分两种情况：在“编辑资料”页面中未作修改或修改后未保存退出，在“编辑资料”页面中修改并保存了数据。无论那种情况，改变头像即保存一次，所以“我的”页面的原头像需要换成更新头像，对于昵称而言，只有在“编辑资料”页面保存了，才会在“我的”页面显示更新昵称。那么可以在“我的”页面的onShow()中拿取在缓存中的headAddr和nickname并将其二者赋值给当前页面的headAddr和nickname。



# 2022.3.15

## 我的-成长记录

## 我的-设置

环节1：用户点击“设置”进入到设置页面。目前只提供“退出登录”功能，点击退出登录会弹出提醒框，在用户确认登录后，将缓存中的isLogin和token分别变为false和清空，并在随后跳转到“登录”页面，这里使用wx.reLaunch()以确保用户不可回退页面

# 注意事项：

在对更新头像接口进行请求时，发现返回的路径每次都是一样的（相对于服务器的路径）。在拿完值后使用setData()函数进行数据更新时发现，新的头像并不会显示，查看html结构发现路径确实已经改变。根据本人细心缜密的推理以及查阅网上相关资料得知，**微信小程序对相同的内容替换不会造成视图的更新**。因此，解决办法是在得到的路径后面加上`http://xxx/x/?t=${new Date()}`来实现每次获取的路径都不同。但是随后又考虑到手机端可能不存在new Date()这一函数，于是将其替换成wx.getRandomValues()。

关于实现“我的”页面和“编辑资料”页面的头像一致问题。一开始用户获取到的头像数据经过一次随机取数并且赋值给页面data中的headAddr然后被存放到缓存中，此时用户打开“编辑资料”页面进行更换头像的操作又会进行一次随机取数操作并且赋值给页面data中的headAddr然后被存放如缓存中。细心的你已经发现了，此时在“我的”页面中的headAddr以及与缓存中的headAddr有差异，因此只需要在“我的”onShow()函数中从缓存拿取headAddr并赋值给页面data中的数据就可以了